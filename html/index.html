<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link href="bootstrap.min.css" rel="stylesheet">
  <link href="webping.css" rel="stylesheet">

  <title>WebPing</title>
</head>

<body>

  <div class="container d-flex flex-column vh-100 p-3">

    <header class="mb-auto">
      <div>
        <h1 class="float-start mb-0">
          <a href="/"><span id="logo" class="logo"></span> <span id="title">WebPing</span></a>
        </h1>
        <nav class="nav nav-masthead justify-content-center float-end" role="tablist">
          <a class="nav-link active" id="home-tab" data-bs-toggle="tab" href="#home" role="tab">Home</a>
          <a class="nav-link" id="map-tab" data-bs-toggle="tab" href="#map" role="tab">World map</a>

          <a class="nav-link" id="how-tab" data-bs-toggle="tab" href="#how" role="tab">How it works</a>
        </nav>
      </div>
    </header>

    <section class="tab-content mx-auto px-3 my-5" id="tabContent">
      <div class="tab-pane fade show active" id="home" role="tabpanel">
        <h2 class="my-3">HTTP latency to major cloud regions</h2>
        <p>Your IP:&nbsp;&nbsp;&nbsp;<span id="ip_addr">___.___.___.___<span></p>

        <div class="form-check form-switch form-check-inline">
          <input class="form-check-input" type="checkbox" id="switchActive" checked>
          <label class="form-check-label" for="switchActive">Active</label>
        </div>
        <!--
            <div class="form-check form-switch form-check-inline">
              <input class="form-check-input" type="checkbox" id="switchActive" checked disabled>
              <label class="form-check-label" for="switchActive">Auto-sort</label>
            </div>-->

        <table class="table table-dark my-3" id='latencyTable'>
          <thead>
            <tr>
              <th scope="col">Target</th>
              <th scope="col">Latency (ms)</th>
              <th scope="col">Best</th>
              <th scope="col">Sparkline</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Microsoft Teams</td>
              <td class="target text-end pe-4" id='ms-teams' endpoint='https://teams.microsoft.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Microsoft Outlook Online</td>
              <td class="target text-end pe-4" id='ms-outlook' endpoint='https://outlook.office.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Microsoft Office Portal</td>
              <td class="target text-end pe-4" id='ms-office-portal' endpoint='https://portal.office.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Microsoft Azure Portal</td>
              <td class="target text-end pe-4" id='ms-azure-portal' endpoint='https://portal.azure.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Scaleway Paris (France)</td>
              <td class="target text-end pe-4" id='scw-fr-par' endpoint='https://s3.fr-par.scw.cloud/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Azure France Central (France)</td>
              <td class="target text-end pe-4" id='azure-fr-central' endpoint='https://astfrancecentral.blob.core.windows.net/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Azure West Europe (Netherlands)</td>
              <td class="target text-end pe-4" id='azure-eu-west' endpoint='https://astwesteurope.blob.core.windows.net/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>Azure East US (Virginia, USA)</td>
              <td class="target text-end pe-4" id='azure-us-east' endpoint='https://asteastus.blob.core.windows.net/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS US-East (Virginia)</td>
              <td class="target text-end pe-4" id='us-east-1' endpoint='https://dynamodb.us-east-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Europe (Ireland)</td>
              <td class="target text-end pe-4" id='eu-west-1' endpoint='https://dynamodb.eu-west-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Europe (London)</td>
              <td class="target text-end pe-4" id='eu-west-2' endpoint='https://dynamodb.eu-west-2.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Europe (Frankfurt)</td>
              <td class="target text-end pe-4" id='eu-central-1' endpoint='https://dynamodb.eu-central-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Europe (Paris)</td>
              <td class="target text-end pe-4" id='eu-west-3' endpoint='https://dynamodb.eu-west-3.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Asia Pacific (Hong Kong)</td>
              <td class="target text-end pe-4" id='ap-east-1' endpoint='https://dynamodb.ap-east-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Asia Pacific (Mumbai)</td>
              <td class="target text-end pe-4" id='ap-south-1' endpoint='https://dynamodb.ap-south-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
            <tr>
              <td>AWS Asia Pacific (Singapore)</td>
              <td class="target text-end pe-4" id='ap-southeast-1' endpoint='https://dynamodb.ap-southeast-1.amazonaws.com/'></td>
              <td class="text-end pe-4"></td>
              <td><svg class="sparkline sparkline--blue sparkline--filled" width="100" height="30" stroke-width="3" data-latencies=""></svg></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="tab-pane fade show" id="map" role="tabpanel">
        <h2>TODO: Worldmap</h2>
      </div>
      <div class="tab-pane fade show" id="how" role="tabpanel">
        <h2 class="text-info">How it works</h2>
        <h4 class="text-info">It's a bit tricky to measure latency from browsers!</h4>
        <ul>
          <li>JavaScript doesn't allow to send an ICMP ping (anyway, it's often blocked!)</li>
          <li>Web browser <a href="https://en.wikipedia.org/wiki/Same-origin_policy">Same Origin Policy</a> doesn't allow dynamically loading resources from another domain, unless there is a specific Cross-origin resource sharing (CORS) configuration.</li>
        </ul>
        <p>The <span class="text-info">first trick</span> (<a href="https://stackoverflow.com/questions/4282151/is-it-possible-to-ping-a-server-from-javascript">discussed here on Stack Overflow</a>) is to load an image because &lt;IMG&gt; tags are exempted from Same Origin Policy (<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">see Mozilla Web Developer site for the complete list of exceptions</a>). </p>
        <p>The <span class="text-info">second trick</span> is to append a random query parameter. E.g.:</p>
        <blockquote><code>img.src = url + '?no-cache=' + Math.floor((1 + Math.random()) * 0x10000).toString(16);</code></blockquote>
        <p>It avoids proxy/server caching and the server answers with a (usually short) 404 message. We don't really care about the answer. We just want to know how long the answer takes to come back.</p>
        <p>The <span class="text-info">third trick</span> is to capture the image <code>onload</code> event in JavaScript to calculate the time taken to get the answer from the server.</p>
        <blockquote><code>img.onload = function() { resolve(img); };</code></blockquote>
        <h4 class="text-info">How accurate is it?</h4>
        <p>The latency measured is actually an HTTP latency: it includes browser processing (quite minimal), network transit and web server processing (it can be significant). For small latencies (e.g. 5-10ms), it's probably 2 or 3 times higher than a typical ping. But for bigger latencies (&gt;100ms), the difference with ICMP ping is less noticeable because the network transit part becomes larger.</p>
      </div>

    </section>

    <footer class="mx-auto mt-auto text-white-50">
      <p>Maintained by <a href="https://www.hleroy.com/a-propos/">Herv√© Le Roy</a>. Play with it on <a href="https://codepen.io/billsolo/pen/OJREpLM">Codepen.io</a>. Fork it on <a href="https://github.com/hleroy/webping">Github</a></p>
      <p>Credit and thanks to:</p>
      <ul>
        <li><a href="https://github.com/jdfreder/pingjs">jfreder</a> for its Javascript ping code</li>
        <li><a href="https://github.com/fnando/sparkline">fnando</a> for its lightweight sparkline library</a></li>
        <li><a href="https://ipinfo.io/">ipinfo.io</a> for their free IP information API.</li>
      </ul>
    </footer>

  </div>

  <!-- Javascript -->
  <script src="bootstrap.bundle.min.js"></script>
  <script src="sparkline.js"></script>
  <script src="webping.js"></script>

</body>

</html>